# Activate conda env, set minimal viable threads, export correct environments variables

THREADS = 1

rule all:
    input:
        "outputs/summary.csv"

rule schema_check:
    input:
        rna      = "data/rna.csv",
        variants = "data/variants.csv",
        coldata  = "data/colData.csv"
    output:
        ok = "outputs/schema_ok.txt"
    threads: THREADS
    log:
        "logs/schema_check.log"
    shell:
        r"""
        set -euo pipefail
        mkdir -p outputs logs
        export RNA_PATH="{input.rna}"
        export VARIANTS_PATH="{input.variants}"
        export COLDATA_PATH="{input.coldata}"
        export OUT_OK="{output.ok}"
        Rscript scripts/check_schema.R > {log} 2>&1
        """

rule generate_summary:
    input:
        rna      = "data/rna.csv",
        variants = "data/variants.csv",
        coldata  = "data/colData.csv",
        ok       = "outputs/schema_ok.txt"
    output:
        summary  = "outputs/summary.csv"
    threads: THREADS
    log:
        "logs/generate_summary.log"
    shell:
        r"""
        set -euo pipefail
        mkdir -p outputs logs
        export RNA_PATH="{input.rna}"
        export VARIANTS_PATH="{input.variants}"
        export COLDATA_PATH="{input.coldata}"
        export OUT_PATH="{output.summary}"
        Rscript scripts/run_etl.R > {log} 2>&1
        """
